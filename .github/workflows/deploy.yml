name: CELDYQUE í†µí•© ê²€ì‚¬ ë° ë°°í¬

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install validators
        run: |
          npm install -g htmlhint
          npm install -g linkinator

      # ===== 1. íŒŒì¼ ì¡´ì¬ ê²€ì‚¬ =====
      - name: File Existence Check
        run: |
          echo "ğŸ“ í•„ìˆ˜ íŒŒì¼ ê²€ì‚¬..."
          REQUIRED_FILES="index.html shop.html about.html faq.html"
          for file in $REQUIRED_FILES; do
            if [ ! -f "$file" ]; then
              echo "âŒ ì—ëŸ¬: $file ì—†ìŒ"
              exit 1
            fi
          done
          echo "âœ… í•„ìˆ˜ íŒŒì¼ í™•ì¸ ì™„ë£Œ"

      # ===== 2. HTML ë¬¸ë²• ê²€ì‚¬ =====
      - name: HTML Validation
        run: |
          echo "ğŸ” HTML ë¬¸ë²• ê²€ì‚¬..."
          htmlhint "*.html" --config .htmlhintrc || true
          
          # ì¹˜ëª…ì  ì˜¤ë¥˜ë§Œ ì²´í¬ (ë‹«íˆì§€ ì•Šì€ íƒœê·¸)
          for file in *.html; do
            if ! grep -q "</html>" "$file"; then
              echo "âŒ $file: </html> íƒœê·¸ ëˆ„ë½"
              exit 1
            fi
            if ! grep -q "</head>" "$file"; then
              echo "âŒ $file: </head> íƒœê·¸ ëˆ„ë½"
              exit 1
            fi
          done
          echo "âœ… HTML ê²€ì‚¬ ì™„ë£Œ"

      # ===== 3. SEO í•„ìˆ˜ ìš”ì†Œ ê²€ì‚¬ =====
      - name: SEO Check
        run: |
          echo "ğŸ” SEO ê²€ì‚¬..."
          ERRORS=0
          
          for file in *.html; do
            # title íƒœê·¸
            if ! grep -q "<title>" "$file"; then
              echo "âš ï¸ $file: <title> ì—†ìŒ"
              ERRORS=$((ERRORS+1))
            fi
            
            # meta description
            if ! grep -q 'meta name="description"' "$file"; then
              echo "âš ï¸ $file: meta description ì—†ìŒ"
              ERRORS=$((ERRORS+1))
            fi
            
            # viewport
            if ! grep -q 'meta name="viewport"' "$file"; then
              echo "âš ï¸ $file: viewport ì—†ìŒ"
              ERRORS=$((ERRORS+1))
            fi
          done
          
          if [ $ERRORS -gt 5 ]; then
            echo "âŒ SEO ì˜¤ë¥˜ $ERRORSê°œ (5ê°œ ì´ˆê³¼ ì‹œ ì‹¤íŒ¨)"
            exit 1
          fi
          echo "âœ… SEO ê²€ì‚¬ ì™„ë£Œ (ê²½ê³ : $ERRORSê°œ)"

      # ===== 4. ë‚´ë¶€ ë§í¬ ê²€ì‚¬ =====
      - name: Internal Link Check
        run: |
          echo "ğŸ”— ë‚´ë¶€ ë§í¬ ê²€ì‚¬..."
          
          # HTML íŒŒì¼ì—ì„œ href ì¶”ì¶œ í›„ ì¡´ì¬ í™•ì¸
          for file in *.html; do
            # ë‚´ë¶€ .html ë§í¬ë§Œ ì¶”ì¶œ
            LINKS=$(grep -oP 'href="[^"#]*\.html' "$file" | sed 's/href="//' | sort -u)
            for link in $LINKS; do
              # ì™¸ë¶€ ë§í¬ ì œì™¸
              if [[ ! "$link" =~ ^http ]]; then
                if [ ! -f "$link" ]; then
                  echo "âŒ $file â†’ $link (íŒŒì¼ ì—†ìŒ)"
                  exit 1
                fi
              fi
            done
          done
          echo "âœ… ë‚´ë¶€ ë§í¬ ê²€ì‚¬ ì™„ë£Œ"

      # ===== 5. ì´ë¯¸ì§€ alt íƒœê·¸ ê²€ì‚¬ =====
      - name: Image Accessibility Check
        run: |
          echo "ğŸ–¼ï¸ ì´ë¯¸ì§€ ì ‘ê·¼ì„± ê²€ì‚¬..."
          MISSING_ALT=0
          
          for file in *.html; do
            # alt ì—†ëŠ” img íƒœê·¸ ì°¾ê¸°
            COUNT=$(grep -c '<img[^>]*[^a]>' "$file" 2>/dev/null | grep -v 'alt=' || echo 0)
            if grep -q '<img ' "$file"; then
              if ! grep -q '<img[^>]*alt=' "$file"; then
                echo "âš ï¸ $file: alt ì—†ëŠ” ì´ë¯¸ì§€ ì¡´ì¬ ê°€ëŠ¥"
                MISSING_ALT=$((MISSING_ALT+1))
              fi
            fi
          done
          echo "âœ… ì´ë¯¸ì§€ ê²€ì‚¬ ì™„ë£Œ (ê²½ê³ : $MISSING_ALTê°œ)"

      # ===== 6. ë³´ì•ˆ ê²€ì‚¬ =====
      - name: Security Check
        run: |
          echo "ğŸ”’ ë³´ì•ˆ ê²€ì‚¬..."
          
          for file in *.html; do
            # ì¸ë¼ì¸ onclick (XSS ìœ„í—˜)
            if grep -q 'javascript:' "$file"; then
              echo "âš ï¸ $file: javascript: í”„ë¡œí† ì½œ ë°œê²¬"
            fi
            
            # ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ integrity ì—†ìŒ
            if grep -q '<script src="http' "$file"; then
              if ! grep -q 'integrity=' "$file"; then
                echo "âš ï¸ $file: ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ integrity ì—†ìŒ"
              fi
            fi
          done
          echo "âœ… ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"

      # ===== 7. íŒŒì¼ í¬ê¸° ê²€ì‚¬ =====
      - name: File Size Check
        run: |
          echo "ğŸ“Š íŒŒì¼ í¬ê¸° ê²€ì‚¬..."
          MAX_SIZE=500000  # 500KB
          
          for file in *.html; do
            SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
            if [ "$SIZE" -gt "$MAX_SIZE" ]; then
              echo "âš ï¸ $file: ${SIZE}bytes (500KB ì´ˆê³¼)"
            fi
          done
          echo "âœ… íŒŒì¼ í¬ê¸° ê²€ì‚¬ ì™„ë£Œ"

  deploy:
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment Summary
        run: |
          echo "ğŸš€ ë°°í¬ ì™„ë£Œ!"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"